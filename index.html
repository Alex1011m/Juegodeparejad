<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego para Parejas</title>
    <!-- Configuraci√≥n de Tailwind para el modo oscuro -->
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle, #fce7f3 0%, #d8b4fe 100%);
        }
        .dark body {
            background: #111827;
        }
        .text-shadow-lg {
            text-shadow: 3px 3px 6px rgba(0,0,0,0.2);
        }
        .dark .text-shadow-lg {
            text-shadow: 0 0 10px rgba(var(--accent-color-rgb), 0.7), 0 0 20px rgba(var(--accent-color-rgb), 0.5);
        }
        .animate-pulse-slow {
            animation: pulse-slow 3s infinite;
        }
        @keyframes pulse-slow {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }
        .top-bar-container {
            position: absolute;
            top: 1rem;
            right: 1rem;
            left: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            z-index: 10;
        }
        .back-button {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .settings-button, .dark-mode-toggle {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #progress-bar-container {
            height: 10px;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        #progress-bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
            background-color: var(--accent-color);
        }
        .dark #progress-bar {
            background-color: var(--accent-color);
        }
        .level-card {
            transition: transform 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .level-card:hover {
            transform: scale(1.05);
            border: 2px solid var(--accent-color);
        }
        .color-picker-button {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }
        .color-picker-button:hover {
            transform: scale(1.1);
            border: 2px solid #fff;
        }
        .color-picker-button.active {
            transform: scale(1.2);
            border: 3px solid #fff;
        }
        .prize-input-container {
            display: none;
        }
        .prize-input-container.active {
            display: block;
        }
        .gemini-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 9999px;
            background-color: #fce7f3;
            color: #ec4899;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }
        .dark .gemini-button {
            background-color: #27272a;
            color: #a855f7;
        }
        .gemini-button:hover {
            transform: scale(1.1);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex items-center justify-center p-4 transition-colors duration-500" style="--accent-color: #ec4899; --accent-color-rgb: 236, 72, 153;">
    <div class="top-bar-container">
        <div id="back-button-container" class="hidden">
            <button onclick="goBack()" class="back-button bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </button>
        </div>
        <div class="flex items-center gap-4">
            <select id="language-select" class="px-4 py-2 rounded-full border border-gray-300 dark:border-gray-700 dark:bg-gray-700 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-pink-500 dark:focus:ring-fuchsia-400 transition-all shadow-md">
                <option value="es">Espa√±ol</option>
                <option value="en">English</option>
            </select>
            <div onclick="toggleSettingsModal()" class="settings-button bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8h12M4 14v4m0-4a2 2 0 100 4m0-4a2 2 0 110 4m16 0v4m0-4a2 2 0 100 4m0-4a2 2 0 110 4m-6-8h12m-6-8v-2m0 2a2 2 0 100-4m0 4a2 2 0 110-4" />
                </svg>
            </div>
            <div onclick="toggleDarkMode()" class="dark-mode-toggle bg-white dark:bg-gray-800 text-gray-800 dark:text-yellow-400">
                <svg id="moon-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
                </svg>
                <svg id="sun-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2.25a.75.75 0 01.75.75v2.5a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.52 7.52a.75.75 0 011.06-1.06l1.77 1.77a.75.75 0 01-1.06 1.06L7.52 7.52zM3 12a.75.75 0 01.75-.75h2.5a.75.75 0 010 1.5H3.75A.75.75 0 013 12zM7.52 16.48a.75.75 0 01-1.06 1.06l-1.77-1.77a.75.75 0 011.06-1.06l1.77 1.77zM12 18.25a.75.75 0 01-.75.75v2.5a.75.75 0 011.5 0v-2.5a.75.75 0 01-.75-.75zM16.48 16.48a.75.75 0 011.06-1.06l1.77 1.77a.75.75 0 01-1.06 1.06l-1.77-1.77zM18.25 12a.75.75 0 01.75-.75h2.5a.75.75 0 010 1.5h-2.5a.75.75 0 01-.75-.75zM16.48 7.52a.75.75 0 011.06-1.06l1.77 1.77a.75.75 0 01-1.06 1.06l-1.77-1.77z"></path>
                </svg>
            </div>
        </div>
    </div>
    <div id="game-container" class="w-full max-w-4xl bg-white dark:bg-gray-800 p-6 md:p-10 rounded-3xl shadow-2xl flex flex-col items-center text-center transition-all duration-500 transform scale-100 animate-pulse-slow">
        <!-- Pantalla de inicio -->
        <div id="start-screen" class="space-y-6 w-full">
            <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-red-500 dark:from-fuchsia-400 dark:to-cyan-400 mb-2 text-shadow-lg" id="main-title">Juego para Parejas <span id="heart-icon" class="transition-colors duration-1000">‚ù§Ô∏è</span></h1>
            <p class="text-gray-600 dark:text-gray-400 text-sm" id="developer-note">Desarrollador: PandA</p>
            <p class="text-gray-600 dark:text-gray-400 text-lg" id="game-description">Un juego de trivia y desaf√≠os para descubrir y celebrar su conexi√≥n.</p>
            <div class="space-y-4">
                <input type="text" id="player1-name" placeholder="Nombre del Jugador 1" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-gray-700 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-pink-500 dark:focus:ring-fuchsia-400 transition-all shadow-md" oninput="togglePrizeInput(1)">
                <div id="player1-prize-container" class="prize-input-container">
                    <div class="flex items-center gap-2">
                         <input type="text" id="player1-prize" placeholder="Si gano, quiero que..." class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-gray-700 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-pink-500 dark:focus:ring-fuchsia-400 transition-all shadow-md">
                         <button onclick="generatePrizeIdea(1)" class="gemini-button text-xl">‚ú®</button>
                    </div>
                </div>
                <input type="text" id="player2-name" placeholder="Nombre del Jugador 2" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-gray-700 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-pink-500 dark:focus:ring-fuchsia-400 transition-all shadow-md" oninput="togglePrizeInput(2)">
                <div id="player2-prize-container" class="prize-input-container">
                    <div class="flex items-center gap-2">
                        <input type="text" id="player2-prize" placeholder="Si gano, quiero que..." class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-gray-700 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-pink-500 dark:focus:ring-fuchsia-400 transition-all shadow-md">
                        <button onclick="generatePrizeIdea(2)" class="gemini-button text-xl">‚ú®</button>
                    </div>
                </div>
            </div>
            <button onclick="startGame()" class="w-full py-3 px-6 text-lg font-semibold text-white bg-pink-500 dark:bg-fuchsia-600 rounded-full shadow-lg hover:bg-pink-600 dark:hover:bg-fuchsia-700 transition-all transform hover:scale-105" id="start-button">Empezar a Jugar ‚ú®</button>
        </div>

        <!-- Pantalla de selecci√≥n de nivel -->
        <div id="level-screen" class="hidden space-y-6 w-full">
            <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-100" id="level-title">Elige tu modo de juego</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Modo Conexi√≥n -->
                <div class="level-card bg-pink-400 dark:bg-fuchsia-600 text-white p-6 rounded-3xl shadow-xl flex flex-col justify-between transition-all transform hover:scale-105">
                    <div>
                        <h3 class="text-2xl font-bold" id="level1-title">Nivel 1: Conexi√≥n ü•∞</h3>
                        <p class="text-sm mt-2 font-normal" id="level1-desc">Preguntas suaves y divertidas para conocerse mejor y fortalecer su v√≠nculo.</p>
                    </div>
                    <button onclick="selectLevel(1)" class="w-full mt-4 py-3 px-6 text-lg font-semibold text-white bg-pink-500 dark:bg-fuchsia-700 rounded-full shadow-lg hover:bg-pink-600 dark:hover:bg-fuchsia-800 transition-all" id="level1-button">
                        ¬°A jugar!
                    </button>
                </div>

                <!-- Modo Pasi√≥n -->
                <div class="level-card bg-rose-500 dark:bg-violet-600 text-white p-6 rounded-3xl shadow-xl flex flex-col justify-between transition-all transform hover:scale-105">
                    <div>
                        <h3 class="text-2xl font-bold" id="level2-title">Nivel 2: Pasi√≥n üî•</h3>
                        <p class="text-sm mt-2 font-normal" id="level2-desc">Suban un poco la temperatura con desaf√≠os y preguntas m√°s √≠ntimas.</p>
                    </div>
                    <button onclick="selectLevel(2)" class="w-full mt-4 py-3 px-6 text-lg font-semibold text-white bg-rose-600 dark:bg-violet-700 rounded-full shadow-lg hover:bg-rose-700 dark:hover:bg-violet-800 transition-all" id="level2-button">
                        ¬°Vamos!
                    </button>
                </div>
                
                <!-- Modo Aventura -->
                <div class="level-card bg-red-600 dark:bg-cyan-600 text-white p-6 rounded-3xl shadow-xl flex flex-col justify-between transition-all transform hover:scale-105">
                    <div>
                        <h3 class="text-2xl font-bold" id="level3-title">Nivel 3: Aventura üòà</h3>
                        <p class="text-sm mt-2 font-normal" id="level3-desc">Lleven las cosas a un nivel atrevido y excitante. ¬°Solo para los valientes!</p>
                    </div>
                    <button onclick="selectLevel(3)" class="w-full mt-4 py-3 px-6 text-lg font-semibold text-white bg-red-700 dark:bg-cyan-700 rounded-full shadow-lg hover:bg-red-800 dark:hover:bg-cyan-800 transition-all" id="level3-button">
                        ¬°Atr√©vete!
                    </button>
                </div>
                
                <!-- Modo Variado -->
                <div class="level-card bg-purple-500 dark:bg-indigo-600 text-white p-6 rounded-3xl shadow-xl flex flex-col justify-between transition-all transform hover:scale-105 md:col-span-2 lg:col-span-1">
                    <div>
                        <h3 class="text-2xl font-bold" id="level0-title">Modo Variado üé≤</h3>
                        <p class="text-sm mt-2 font-normal" id="level0-desc">Un mix al azar de todos los niveles. ¬°Nunca sabr√°n qu√© sigue!</p>
                    </div>
                    <button onclick="selectLevel(0)" class="w-full mt-4 py-3 px-6 text-lg font-semibold text-white bg-purple-600 dark:bg-indigo-700 rounded-full shadow-lg hover:bg-purple-700 dark:hover:bg-indigo-800 transition-all" id="level0-button">
                        ¬°Sorpr√©ndete!
                    </button>
                </div>

                <!-- Modo Solo Preguntas -->
                <div class="level-card bg-blue-500 dark:bg-blue-700 text-white p-6 rounded-3xl shadow-xl flex flex-col justify-between transition-all transform hover:scale-105 md:col-span-2 lg:col-span-1">
                    <div>
                        <h3 class="text-2xl font-bold" id="level4-title">Modo Solo Preguntas üó£Ô∏è</h3>
                        <p class="text-sm mt-2 font-normal" id="level4-desc">Un modo centrado en la comunicaci√≥n. Solo recibir√°n preguntas de todos los niveles.</p>
                    </div>
                    <button onclick="selectLevel(4)" class="w-full mt-4 py-3 px-6 text-lg font-semibold text-white bg-blue-600 dark:bg-blue-800 rounded-full shadow-lg hover:bg-blue-700 dark:hover:bg-blue-900 transition-all" id="level4-button">
                        ¬°A Hablar!
                    </button>
                </div>

                <!-- Modo Solo Retos -->
                <div class="level-card bg-orange-500 dark:bg-amber-600 text-white p-6 rounded-3xl shadow-xl flex flex-col justify-between transition-all transform hover:scale-105 md:col-span-2 lg:col-span-1">
                    <div>
                        <h3 class="text-2xl font-bold" id="level5-title">Modo Solo Retos ü§∏</h3>
                        <p class="text-sm mt-2 font-normal" id="level5-desc">¬°Para cuando solo quieren acci√≥n! Retos f√≠sicos y divertidos de todos los niveles.</p>
                    </div>
                    <button onclick="selectLevel(5)" class="w-full mt-4 py-3 px-6 text-lg font-semibold text-white bg-orange-600 dark:bg-amber-700 rounded-full shadow-lg hover:bg-orange-700 dark:hover:bg-amber-800 transition-all" id="level5-button">
                        ¬°A Retar!
                    </button>
                </div>

                <!-- Modo Progresivo -->
                <div class="level-card bg-teal-500 dark:bg-teal-700 text-white p-6 rounded-3xl shadow-xl flex flex-col justify-between transition-all transform hover:scale-105 md:col-span-2 lg:col-span-1">
                    <div>
                        <h3 class="text-2xl font-bold" id="level6-title">Modo Progresivo üìà</h3>
                        <p class="text-sm mt-2 font-normal" id="level6-desc">El juego empieza suave y se vuelve m√°s atrevido con el tiempo.</p>
                    </div>
                    <button onclick="selectLevel(6)" class="w-full mt-4 py-3 px-6 text-lg font-semibold text-white bg-teal-600 dark:bg-teal-800 rounded-full shadow-lg hover:bg-teal-700 dark:hover:bg-teal-900 transition-all" id="level6-button">
                        ¬°Avanza!
                    </button>
                </div>

                <!-- Modo Personalizado -->
                <div class="level-card bg-yellow-500 dark:bg-lime-600 text-white p-6 rounded-3xl shadow-xl flex flex-col justify-between transition-all transform hover:scale-105 md:col-span-2 lg:col-span-1">
                    <div>
                        <h3 class="text-2xl font-bold" id="level7-title">Modo Personalizado ‚úèÔ∏è</h3>
                        <p class="text-sm mt-2 font-normal" id="level7-desc">Creen su propio banco de preguntas y retos para una experiencia √∫nica.</p>
                    </div>
                    <button onclick="selectLevel(7)" class="w-full mt-4 py-3 px-6 text-lg font-semibold text-white bg-yellow-600 dark:bg-lime-700 rounded-full shadow-lg hover:bg-yellow-700 dark:hover:bg-lime-800 transition-all" id="level7-button">
                        ¬°A crear!
                    </button>
                </div>
            </div>
        </div>

        <!-- Pantalla de creaci√≥n de retos -->
        <div id="create-game-screen" class="hidden space-y-6 w-full">
            <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-100" id="create-title">Crea tus propias preguntas y retos</h2>
            <div class="space-y-4">
                <textarea id="custom-question-input" placeholder="Escribe tu pregunta o reto aqu√≠..." class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-gray-700 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-yellow-500 dark:focus:ring-lime-400 transition-all shadow-md min-h-[150px]"></textarea>
                <button onclick="addCustomQuestion()" class="w-full py-3 px-6 text-lg font-semibold text-white bg-yellow-500 dark:bg-lime-600 rounded-full shadow-lg hover:bg-yellow-600 dark:hover:bg-lime-700 transition-all transform hover:scale-105" id="add-question-button">
                    Agregar a mi juego ‚ú®
                </button>
            </div>
            <button onclick="startCustomGame()" class="w-full py-3 px-6 text-lg font-semibold text-white bg-pink-500 dark:bg-fuchsia-600 rounded-full shadow-lg hover:bg-pink-600 dark:hover:bg-fuchsia-700 transition-all transform hover:scale-105" id="play-custom-button">¬°Jugar con mis retos! üéâ</button>
        </div>

        <!-- Pantalla de selecci√≥n de rondas -->
        <div id="rounds-screen" class="hidden space-y-6 w-full">
            <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-100" id="rounds-title">¬øCu√°ntas rondas quieren jugar?</h2>
            <div class="space-y-4">
                <select id="total-rounds-select" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-gray-700 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-pink-500 dark:focus:ring-fuchsia-400 transition-all shadow-md">
                    <option value="5" id="option-5-rounds"></option>
                    <option value="10" selected id="option-10-rounds"></option>
                    <option value="15" id="option-15-rounds"></option>
                    <option value="20" id="option-20-rounds"></option>
                    <option value="30" id="option-30-rounds"></option>
                </select>
            </div>
            <button onclick="selectRounds()" class="w-full py-3 px-6 text-lg font-semibold text-white bg-pink-500 dark:bg-fuchsia-600 rounded-full shadow-lg hover:bg-pink-600 dark:hover:bg-fuchsia-700 transition-all transform hover:scale-105" id="start-game-button">¬°Empezar Partida! üéâ</button>
        </div>
        
        <!-- Pantalla de juego -->
        <div id="game-screen" class="hidden space-y-6 w-full">
            <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mb-4">
                <div id="progress-bar" class="bg-pink-600 h-2.5 rounded-full dark:bg-fuchsia-500 transition-all duration-500 ease-in-out" style="width: 0%;"></div>
            </div>
            <div class="flex items-center justify-between w-full mb-4">
                <div class="flex flex-col items-start">
                    <span id="player1-score-display" class="text-sm font-semibold text-gray-500 dark:text-gray-400"></span>
                    <span id="player-turn" class="text-xl font-bold text-gray-700 dark:text-gray-100"></span>
                </div>
                <div class="flex flex-col items-end">
                    <span id="player2-score-display" class="text-sm font-semibold text-gray-500 dark:text-gray-400"></span>
                </div>
            </div>
            <div class="flex items-center justify-center space-x-4 mb-4">
                <p id="round-display" class="text-sm font-semibold text-gray-500 dark:text-gray-400"></p>
                <div id="timer-display" class="w-8 h-8 flex items-center justify-center rounded-full bg-pink-500 dark:bg-fuchsia-600 text-white font-bold shadow-md"></div>
            </div>
            <div id="question-box" class="bg-gray-100 dark:bg-gray-700 p-8 rounded-2xl shadow-inner min-h-[250px] flex items-center justify-center">
                <p id="question-text" class="text-2xl text-gray-800 dark:text-gray-100 font-semibold leading-relaxed"></p>
            </div>
            <div id="action-buttons" class="w-full flex justify-center space-x-4 mt-6">
                <button onclick="addPointAndNext()" class="flex-1 py-4 px-6 text-lg font-semibold text-white bg-green-500 dark:bg-emerald-500 rounded-full shadow-lg hover:bg-green-600 dark:hover:bg-emerald-600 transition-all transform hover:scale-105" id="win-button">
                    ¬°Lo logr√©! üéâ
                </button>
                <button onclick="passWithConsequence()" class="flex-1 py-4 px-6 text-lg font-semibold text-white bg-gray-400 dark:bg-gray-600 rounded-full shadow-lg hover:bg-gray-500 dark:hover:bg-gray-700 transition-all transform hover:scale-105" id="pass-button">
                    Pasar ‚û°Ô∏è
                </button>
            </div>
             <div class="mt-4 flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                <button onclick="readQuestion()" class="py-2 px-4 text-sm font-semibold text-white bg-blue-500 dark:bg-blue-600 rounded-full shadow-lg hover:bg-blue-600 dark:hover:bg-blue-700 transition-all transform hover:scale-105" id="read-button">Leer Pregunta ‚ú®</button>
                <button onclick="generateQuestionWithGemini()" class="py-2 px-4 text-sm font-semibold text-white bg-purple-500 dark:bg-purple-600 rounded-full shadow-lg hover:bg-purple-600 dark:hover:bg-purple-700 transition-all transform hover:scale-105" id="gemini-question-button">Nueva Pregunta ‚ú®</button>
            </div>
            <button onclick="restartGame()" class="mt-4 text-pink-500 hover:text-pink-700 dark:text-fuchsia-400 dark:hover:text-fuchsia-500 transition-colors" id="restart-button">Reiniciar</button>
        </div>
        
        <!-- Pantalla final -->
        <div id="end-screen" class="hidden space-y-6 w-full">
            <h2 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-red-500 dark:from-fuchsia-400 dark:to-cyan-400 mb-2" id="end-title">¬°Fin del Juego! üèÅ</h2>
            <p id="winner-message" class="text-2xl font-semibold text-gray-800 dark:text-gray-100"></p>
            <p id="final-scores" class="text-xl text-gray-600 dark:text-gray-400"></p>
            <p class="text-lg text-gray-700 dark:text-gray-300 leading-relaxed mt-4" id="end-message"></p>
            <button onclick="restartGame()" class="w-full py-3 px-6 text-lg font-semibold text-white bg-pink-500 dark:bg-fuchsia-600 rounded-full shadow-lg hover:bg-pink-600 dark:hover:bg-fuchsia-700 transition-all transform hover:scale-105" id="play-again-button">Jugar de Nuevo ‚ú®</button>
        </div>

        <!-- Modal de consentimiento -->
        <div id="consent-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl text-center max-w-sm">
                <h3 class="text-3xl font-bold text-red-600 dark:text-cyan-400 mb-4" id="consent-title"></h3>
                <p class="text-gray-700 dark:text-gray-300 mb-6 text-lg leading-relaxed" id="consent-message">
                </p>
                <button onclick="closeConsentModal()" class="w-full py-3 px-6 text-lg font-semibold text-white bg-red-600 dark:bg-cyan-600 rounded-full shadow-lg hover:bg-red-700 dark:hover:bg-cyan-700 transition-all transform hover:scale-105" id="consent-button"></button>
            </div>
        </div>
        
        <!-- Modal de alerta -->
        <div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl text-center max-w-sm">
                <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4" id="alert-title"></h3>
                <p class="text-gray-700 dark:text-gray-300 mb-6" id="alert-message"></p>
                <button onclick="closeAlertModal()" class="w-full py-3 px-6 text-lg font-semibold text-white bg-pink-500 dark:bg-fuchsia-600 rounded-full shadow-lg hover:bg-pink-600 dark:hover:bg-fuchsia-700 transition-all transform hover:scale-105" id="alert-button"></button>
            </div>
        </div>

        <!-- Modal de configuraci√≥n -->
        <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl text-center max-w-sm">
                <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4" id="settings-title">Configuraci√≥n</h3>
                <p class="text-gray-700 dark:text-gray-300 mb-4" id="theme-label">Elige un color de tema:</p>
                <div id="color-picker" class="flex justify-center space-x-2">
                    <button class="color-picker-button bg-pink-500 active" onclick="setAccentColor('#ec4899', '236, 72, 153', this)"></button>
                    <button class="color-picker-button bg-blue-500" onclick="setAccentColor('#3b82f6', '59, 130, 246', this)"></button>
                    <button class="color-picker-button bg-green-500" onclick="setAccentColor('#22c55e', '34, 197, 94', this)"></button>
                    <button class="color-picker-button bg-purple-500" onclick="setAccentColor('#a855f7', '168, 85, 247', this)"></button>
                    <button class="color-picker-button bg-red-500" onclick="setAccentColor('#ef4444', '239, 68, 68', this)"></button>
                </div>
                <div class="flex items-center justify-center space-x-2 mt-6">
                    <div onclick="toggleDarkMode()" class="dark-mode-toggle bg-white dark:bg-gray-800 text-gray-800 dark:text-yellow-400">
                        <svg id="moon-icon-settings" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
                        </svg>
                        <svg id="sun-icon-settings" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2.25a.75.75 0 01.75.75v2.5a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.52 7.52a.75.75 0 011.06-1.06l1.77 1.77a.75.75 0 01-1.06 1.06L7.52 7.52zM3 12a.75.75 0 01.75-.75h2.5a.75.75 0 010 1.5H3.75A.75.75 0 013 12zM7.52 16.48a.75.75 0 01-1.06 1.06l-1.77-1.77a.75.75 0 011.06-1.06l1.77 1.77zM12 18.25a.75.75 0 01-.75.75v2.5a.75.75 0 011.5 0v-2.5a.75.75 0 01-.75-.75zM16.48 16.48a.75.75 0 011.06-1.06l1.77 1.77a.75.75 0 01-1.06 1.06l-1.77-1.77zM18.25 12a.75.75 0 01.75-.75h2.5a.75.75 0 010 1.5h-2.5a.75.75 0 01-.75-.75zM16.48 7.52a.75.75 0 011.06-1.06l1.77 1.77a.75.75 0 01-1.06 1.06l-1.77-1.77z"></path>
                        </svg>
                    </div>
                </div>
                <button onclick="closeSettingsModal()" class="w-full py-3 px-6 mt-6 text-lg font-semibold text-white bg-pink-500 dark:bg-fuchsia-600 rounded-full shadow-lg hover:bg-pink-600 dark:hover:bg-fuchsia-700 transition-all transform hover:scale-105" id="close-settings-button">Cerrar</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('debug');
        
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let userId = null;
        window.db = db;
        window.appId = appId;
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("User is signed in with UID:", userId);
            } else {
                console.log("No user is signed in. Attempting anonymous sign-in.");
                try {
                    await signInAnonymously(auth);
                    userId = auth.currentUser.uid;
                    console.log("Anonymous sign-in successful. UID:", userId);
                } catch (error) {
                    console.error("Anonymous sign-in failed:", error);
                }
            }
            window.userId = userId;
            window.loadGame();
        });
        
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            signInWithCustomToken(auth, __initial_auth_token).catch((error) => {
                console.error("Error signing in with custom token:", error);
            });
        }
        
        window.getCustomQuestions = async () => {
            if (!window.userId) return [];
            try {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/custom_questions`));
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => doc.data().question);
            } catch (error) {
                console.error("Error getting custom questions:", error);
                return [];
            }
        };

        window.saveCustomQuestion = async (question) => {
            if (!window.userId) return;
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/custom_questions`), {
                    question: question,
                    timestamp: new Date()
                });
                console.log("Question saved:", question);
            } catch (error) {
                console.error("Error saving custom question:", error);
            }
        };

        window.saveGameState = async (state) => {
            if (!window.userId) return;
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/game_state/current_game`), state);
            } catch (error) {
                console.error("Error saving game state:", error);
            }
        };

        window.loadGameState = async () => {
            if (!window.userId) return null;
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/game_state/current_game`);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                } else {
                    return null;
                }
            } catch (error) {
                console.error("Error loading game state:", error);
                return null;
            }
        };

        // Array de colores para el coraz√≥n
        const heartColors = ['#f472b6', '#ef4444', '#ec4899', '#a855f7', '#06b6d4'];
        let currentColorIndex = 0;
        const heartIcon = document.getElementById('heart-icon');

        function changeHeartColor() {
            if (heartIcon) {
                currentColorIndex = (currentColorIndex + 1) % heartColors.length;
                heartIcon.style.color = heartColors[currentColorIndex];
            }
        }

        setInterval(changeHeartColor, 1000);

        // Referencias a los elementos del DOM
        const startScreen = document.getElementById('start-screen');
        const levelScreen = document.getElementById('level-screen');
        const roundsScreen = document.getElementById('rounds-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const createGameScreen = document.getElementById('create-game-screen');
        const consentModal = document.getElementById('consent-modal');
        const backButtonContainer = document.getElementById('back-button-container');
        const alertModal = document.getElementById('alert-modal');
        const settingsModal = document.getElementById('settings-modal');

        const player1NameInput = document.getElementById('player1-name');
        const player2NameInput = document.getElementById('player2-name');
        const player1PrizeInput = document.getElementById('player1-prize');
        const player2PrizeInput = document.getElementById('player2-prize');
        const player1PrizeContainer = document.getElementById('player1-prize-container');
        const player2PrizeContainer = document.getElementById('player2-prize-container');
        const player1ScoreDisplay = document.getElementById('player1-score-display');
        const player2ScoreDisplay = document.getElementById('player2-score-display');
        const playerTurnDisplay = document.getElementById('player-turn');
        const roundDisplay = document.getElementById('round-display');
        const questionText = document.getElementById('question-text');
        const winnerMessage = document.getElementById('winner-message');
        const finalScores = document.getElementById('final-scores');
        const endMessage = document.getElementById('end-message');
        const totalRoundsSelect = document.getElementById('total-rounds-select');
        const timerDisplay = document.getElementById('timer-display');
        const progressBar = document.getElementById('progress-bar');
        const languageSelect = document.getElementById('language-select');
        const clickSound = new Audio('https://cdn.pixabay.com/audio/2023/12/03/audio_f83f2a2818.mp3'); 
        
        // Variables del juego
        let player1Name, player2Name, player1Prize, player2Prize;
        let player1Score = 0;
        let player2Score = 0;
        let currentPlayer = 1;
        let currentRound = 1;
        let totalRounds = 10;
        let currentLevel = 1;
        let timerInterval;
        let timeLeft = 30;
        let usedQuestions = {};
        let customQuestions = [];
        let allQuestions = [];

        // Datos del juego (preguntas y retos) en espa√±ol e ingl√©s
        const gameData = {
            es: {
                title: "Juego para Parejas",
                developer: "Desarrollador: PandA",
                description: "Un juego de trivia y desaf√≠os para descubrir y celebrar su conexi√≥n.",
                startButton: "Empezar a Jugar ‚ú®",
                levelTitle: "Elige tu modo de juego",
                level1Title: "Nivel 1: Conexi√≥n ü•∞",
                level1Desc: "Preguntas suaves y divertidas para conocerse mejor y fortalecer su v√≠nculo.",
                level1Button: "¬°A jugar!",
                level2Title: "Nivel 2: Pasi√≥n üî•",
                level2Desc: "Suban un poco la temperatura con desaf√≠os y preguntas m√°s √≠ntimas.",
                level2Button: "¬°Vamos!",
                level3Title: "Nivel 3: Aventura üòà",
                level3Desc: "Lleven las cosas a un nivel atrevido y excitante. ¬°Solo para los valientes!",
                level3Button: "¬°Atr√©vete!",
                level0Title: "Modo Variado üé≤",
                level0Desc: "Un mix al azar de todos los niveles. ¬°Nunca sabr√°n qu√© sigue!",
                level0Button: "¬°Sorpr√©ndete!",
                level4Title: "Modo Solo Preguntas üó£Ô∏è",
                level4Desc: "Un modo centrado en la comunicaci√≥n. Solo recibir√°n preguntas de todos los niveles.",
                level4Button: "¬°A Hablar!",
                level5Title: "Modo Solo Retos ü§∏",
                level5Desc: "¬°Para cuando solo quieren acci√≥n! Retos f√≠sicos y divertidos de todos los niveles.",
                level5Button: "¬°A Retar!",
                level6Title: "Modo Progresivo üìà",
                level6Desc: "El juego empieza suave y se vuelve m√°s atrevido con el tiempo.",
                level6Button: "¬°Avanza!",
                level7Title: "Modo Personalizado ‚úèÔ∏è",
                level7Desc: "Creen su propio banco de preguntas y retos para una experiencia √∫nica.",
                level7Button: "¬°A crear!",
                roundsTitle: "¬øCu√°ntas rondas quieren jugar?",
                roundsOption: (r) => `${r} rondas`,
                startGameButton: "¬°Empezar Partida! üéâ",
                playerPlaceholder: "Nombre del Jugador ",
                prizePlaceholder: "Si gano, quiero que...",
                winButton: "¬°Lo logr√©! üéâ",
                passButton: "Pasar ‚û°Ô∏è",
                restartButton: "Reiniciar",
                endTitle: "¬°Fin del Juego! üèÅ",
                playAgainButton: "Jugar de Nuevo ‚ú®",
                playerTurn: (p) => `Turno de ${p}`,
                roundDisplay: (c, t) => `Ronda ${c} de ${t}`,
                finalScoreMessage: (p1, s1, p2, s2) => `Puntuaciones finales: ${p1}: ${s1}, ${p2}: ${s2}`,
                winMessage: (w, prize) => `${w} es el ganador! Ahora ${w} puede pedir: "${prize}".`,
                drawMessage: "¬°Es un empate! ¬°Ambos deben cumplir un deseo del otro!",
                noWinnerMessage: "Nadie ha ganado. ¬°Ambos deben hacer un deseo para el otro!",
                timeout: "¬°Se acab√≥ el tiempo!",
                consentTitle: "¬°Advertencia de Nivel 3!",
                consentMessage: "Este nivel contiene retos que exploran la intimidad f√≠sica. Recuerden siempre la importancia del consentimiento mutuo. Si algo no se siente bien, digan 'no' y pasen. ¬°La comunicaci√≥n es la clave!",
                consentButton: "Entendido",
                outOfQuestions: "¬°Se han agotado las preguntas! Reinicia el juego o elige un modo diferente.",
                alertTitle: "Error",
                alertNames: "Por favor, ingresa los nombres de ambos jugadores.",
                alertQuestions: "Por favor, agrega al menos 5 preguntas o retos para comenzar el modo personalizado.",
                settingsTitle: "Configuraci√≥n",
                themeLabel: "Elige un color de tema:",
                closeSettingsButton: "Cerrar",
                questions: {
                    1: [
                        "¬øCu√°l es el recuerdo m√°s gracioso que tienen juntos?", "Si pudieran viajar a cualquier lugar del mundo ahora mismo, ¬øa d√≥nde ir√≠an?", "Si tuvieras que describir su risa con una palabra, ¬øcu√°l ser√≠a?", "¬øCu√°l es una canci√≥n que les recuerda el uno al otro?", "¬øQu√© superpoder elegir√≠an tener juntos?", "Si pudieran pasar un d√≠a sin responsabilidades, ¬øqu√© har√≠an?", "¬øCu√°l es el mejor regalo que le has dado?", "¬øCu√°l es el mejor consejo que les han dado sobre el amor?", "¬øQu√© les hizo darse cuenta de que quer√≠an estar juntos?", "¬øQu√© es algo que has aprendido de tu pareja?", "¬øCu√°l es una meta que les gustar√≠a lograr juntos en los pr√≥ximos cinco a√±os?", "¬øCu√°l es el h√°bito m√°s adorable de tu pareja?", "¬øQu√© es algo que tu pareja hace que te hace sentir seguro/a?", "¬øCu√°l es un logro del que se sienten orgullosos como pareja?", "Si pudieran revivir un d√≠a de su relaci√≥n, ¬øcu√°l elegir√≠an?", "¬øQu√© es lo que m√°s extra√±an hacer que hac√≠an cuando empezaron a salir?", "¬øQu√© los hace sentir m√°s conectados emocionalmente?", "¬øCu√°l es su broma interna favorita?", "¬øQu√© han aprendido el uno del otro sobre el amor?", "¬øQu√© es algo que te sorprende de tu pareja incluso hoy en d√≠a?", "¬øCu√°l es la forma m√°s simple de hacerte feliz?", "¬øQu√© es algo que admiras profundamente de tu pareja?"
                    ],
                    2: [
                        "Describan el momento m√°s rom√°ntico que han compartido.", "¬øQu√© tipo de caricias te gustan?", "Nombren una fantas√≠a que les gustar√≠a cumplir juntos.", "¬øCu√°l es su lugar favorito para besarse?", "Dale un masaje en los hombros a tu pareja durante un minuto.", "¬øCu√°l es la parte del cuerpo de tu pareja que m√°s te atrae?", "Describan su cita ideal para un d√≠a lluvioso.", "¬øQu√© los hace sentir m√°s amados y deseados?", "B√©sale en la parte del cuerpo que m√°s te gusta.", "¬øQu√© los hace sentir m√°s sensuales y confiados?", "Acaricia el cabello de tu pareja mientras le dices algo que te encanta de su personalidad.", "¬øCu√°l es su canci√≥n m√°s sensual para bailar lento?", "Describan con tres palabras c√≥mo se sienten cuando se besan.", "Nombren una fantas√≠a no sexual que les gustar√≠a vivir juntos.", "¬øQu√© es lo que m√°s los excita en una cita rom√°ntica?", "Dense un beso que comience lento y se vuelva m√°s apasionado.", "¬øCu√°l es el gesto m√°s rom√°ntico que has hecho por tu pareja?", "Si tuvieran que elegir un sabor para su pasi√≥n, ¬øcu√°l ser√≠a?", "Dale a tu pareja una caricia en la mano que se sienta como un beso.", "Besa la espalda de tu pareja mientras le susurras algo que te gustar√≠a hacerle.", "Masajea los pies de tu pareja durante dos minutos mientras le hablas sobre lo que te atrae de ella.", "¬øCu√°l es tu fantas√≠a de rol play menos sexual pero m√°s sensual?", "Escribe un mensaje sensual en la espalda de tu pareja con tu dedo.", "Dale un beso largo y apasionado a tu pareja sin usar las manos.", "¬øCu√°l es la forma en que m√°s te gusta que te toquen?", "Describan una fantas√≠a que les gustar√≠a cumplir si el tiempo y el lugar no fueran un problema."
                    ],
                    3: [
                        "Describe un lugar inesperado donde les gustar√≠a tener una cita atrevida.", "¬øCu√°l ha sido la fantas√≠a m√°s loca que han tenido?", "Besa el cuello de tu pareja de forma muy sensual.", "¬øQu√© juguete sexual te gustar√≠a usar en pareja?", "Describe una posici√≥n en la que quieras probar.", "Cu√©ntale una fantas√≠a er√≥tica que tengas con tu pareja y c√≥mo te gustar√≠a que fuera.", "Besa cada dedo de los pies de tu pareja.", "Besa cada parte del cuerpo de tu pareja que no le hayas besado antes.", "H√°blale a tu pareja con la voz m√°s sensual que tengas y descr√≠bele algo que te excita de ella.", "Jueguen a 'verdad o reto' pero solo con preguntas y desaf√≠os picantes.", "Dale un beso a tu pareja en el ombligo, subiendo y bajando.", "Dile a tu pareja qu√© es lo que m√°s te gusta de sus gemidos.", "Besa a tu pareja desde el cuello hasta el pecho de forma lenta.", "Haz que tu pareja gima de placer sin tocarla.", "B√©sense apasionadamente con las manos de ambos atadas.", "Dale a tu pareja una 'mordida de amor' en un lugar inesperado.", "T√°pale los ojos a tu pareja y dale besos en diferentes partes del cuerpo para que adivine d√≥nde est√°.", "Desaf√≠ale a tu pareja a un juego de cartas, pero con una apuesta picante.", "Describan qu√© es lo que les atrajo de su pareja en la primera cita.", "Si tuvieran que elegir a una pareja de cine para representarlos, ¬øqui√©nes ser√≠an?", "¬øCu√°l es el recuerdo m√°s √≠ntimo que guardan de su relaci√≥n?", "¬øQu√© los hace sentir m√°s conectados con su pareja en un nivel profundo?", "Dale un masaje en la espalda a tu pareja mientras le susurras algo que te gusta de ella.", "¬øCu√°l es un logro del que te sientes orgulloso como pareja?", "Dale a tu pareja un masaje er√≥tico con los ojos vendados.", "Sus√∫rrale al o√≠do a tu pareja algo que te gustar√≠a hacer con ella en la cama.", "Describe la parte de tu cuerpo que m√°s te gusta que te besen.", "Dale un beso en el abdomen a tu pareja y sube lentamente hasta sus labios.", "B√©sale los dedos de las manos a tu pareja uno por uno, de forma lenta y sensual."
                    ],
                    4: [
                        "Make your partner laugh in 30 seconds, without tickling them!", "Imitate an animal for your partner to guess.", "Make a cocktail using only 2 ingredients and ask your partner to drink it from your mouth."
                    ]
                }
            },
            en: {
                title: "Couples Game",
                developer: "Developer: PandA",
                description: "A trivia and challenge game to discover and celebrate your connection.",
                startButton: "Start Playing ‚ú®",
                levelTitle: "Choose your game mode",
                level1Title: "Level 1: Connection ü•∞",
                level1Desc: "Soft and fun questions to get to know each other better and strengthen your bond.",
                level1Button: "Let's play!",
                level2Title: "Level 2: Passion üî•",
                level2Desc: "Turn up the heat with more intimate challenges and questions.",
                level2Button: "Let's go!",
                level3Title: "Level 3: Adventure üòà",
                level3Desc: "Take things to a daring and exciting level. For the brave ones!",
                level3Button: "Dare to!",
                level0Title: "Varied Mode üé≤",
                level0Desc: "A random mix of all levels. You'll never know what's next!",
                level0Button: "Be surprised!",
                level4Title: "Questions Only Mode üó£Ô∏è",
                level4Desc: "A communication-focused mode. You'll only get questions from all levels.",
                level4Button: "Let's Talk!",
                level5Title: "Challenges Only Mode ü§∏",
                level5Desc: "For when you only want action! Physical and fun challenges from all levels.",
                level5Button: "Let's Challenge!",
                level6Title: "Progressive Mode üìà",
                level6Desc: "The game starts soft and gets more daring over time.",
                level6Button: "Go!",
                level7Title: "Custom Mode ‚úèÔ∏è",
                level7Desc: "Create your own bank of questions and challenges for a unique experience.",
                level7Button: "Create!",
                roundsTitle: "How many rounds do you want to play?",
                roundsOption: (r) => `${r} rounds`,
                startGameButton: "Start Game! üéâ",
                playerPlaceholder: "Player Name ",
                prizePlaceholder: "If I win, I want...",
                winButton: "I did it! üéâ",
                passButton: "Pass ‚û°Ô∏è",
                restartButton: "Restart",
                endTitle: "Game Over! üèÅ",
                playAgainButton: "Play Again ‚ú®",
                playerTurn: (p) => `${p}'s turn`,
                roundDisplay: (c, t) => `Round ${c} of ${t}`,
                finalScoreMessage: (p1, s1, p2, s2) => `Final Scores: ${p1}: ${s1}, ${p2}: ${s2}`,
                winMessage: (w, prize) => `${w} is the winner! Now ${w} can ask for: "${prize}".`,
                drawMessage: "It's a tie! You both must fulfill each other's wish!",
                noWinnerMessage: "Nobody won. You both must make a wish for each other!",
                timeout: "Time's up!",
                consentTitle: "Level 3 Warning!",
                consentMessage: "This level contains challenges that explore physical intimacy. Always remember the importance of mutual consent. If something doesn't feel right, say 'no' and pass. Communication is key!",
                consentButton: "Understood",
                outOfQuestions: "All questions have been used! Restart the game or choose a different mode.",
                alertTitle: "Error",
                alertNames: "Please enter both players' names.",
                alertQuestions: "Please add at least 5 questions or challenges to start custom mode.",
                settingsTitle: "Settings",
                themeLabel: "Choose a theme color:",
                closeSettingsButton: "Close",
                questions: {
                    1: [
                        "What is the funniest memory you have together?", "What romantic movie do you both like?", "If you could travel anywhere in the world right now, where would you go?", "What is your favorite food to share?", "What do you like most about their smile?", "If you had to describe their laugh in one word, what would it be?", "What is a song that reminds you of each other?", "What was your first impression of each other?", "What superpower would you choose to have together?", "If you could spend one day with no responsibilities, what would you do?", "What is the best gift you have ever given them?", "What is the best advice you've been given about love?", "What made you realize you wanted to be together?", "What's one thing you've learned from your partner?", "What's a goal you'd like to achieve together in the next five years?", "What is your partner's most adorable habit?", "What's one thing your partner does that makes you feel safe?", "What is an accomplishment you are proud of as a couple?", "If you could relive one day of your relationship, which one would you choose?", "What do you miss most about what you did when you first started dating?", "What makes you feel most emotionally connected?", "What is your favorite inside joke?", "What have you learned about love from each other?", "What is something that still surprises you about your partner?", "What is the simplest way to make you happy?", "What is something you deeply admire about your partner?"
                    ],
                    2: [
                        "Describe the most romantic moment you've shared.", "What kind of caresses do you like?", "Name a fantasy you would like to fulfill together.", "What is your favorite place to kiss?", "Give your partner a shoulder massage for one minute.", "What part of your partner's body are you most attracted to?", "Describe your ideal date for a rainy day.", "What makes you feel most loved and desired?", "Kiss them on the part of their body you like the most.", "What makes you feel most sensual and confident?", "Stroke your partner's hair while telling them something you love about their personality.", "What's your most sensual song to slow dance to?", "Describe in three words how you feel when you kiss.", "Name a non-sexual fantasy you'd like to live out together.", "What gets you most excited on a romantic date?", "Give each other a kiss that starts slow and becomes more passionate.", "What's the most romantic gesture you've ever done for your partner?", "If you had to choose a flavor for your passion, what would it be?", "Give your partner a caress on their hand that feels like a kiss.", "Kiss your partner's back while you whisper something you'd like to do to them.", "Massage your partner's feet for two minutes while you tell them what you find attractive about them.", "What is your least sexual but most sensual role-play fantasy?", "Write a sensual message on your partner's back with your finger.", "Give your partner a long, passionate kiss without using your hands.", "What is the way you most like to be touched?", "Describe a fantasy you would like to fulfill if time and place were not an issue."
                    ],
                    3: [
                        "Describe an unexpected place where you would like to have a daring date.", "What has been the craziest fantasy you've had?", "Besa el cuello de tu pareja de forma muy sensual.", "¬øQu√© juguete sexual te gustar√≠a usar en pareja?", "Describe una posici√≥n en la que quieras probar.", "Cu√©ntale una fantas√≠a er√≥tica que tengas con tu pareja y c√≥mo te gustar√≠a que fuera.", "Besa cada dedo de los pies de tu pareja.", "Besa cada parte del cuerpo de tu pareja que no le hayas besado antes.", "H√°blale a tu pareja con la voz m√°s sensual que tengas y descr√≠bele algo que te excita de ella.", "Jueguen a 'verdad o reto' pero solo con preguntas y desaf√≠os picantes.", "Dale un beso a tu pareja en el ombligo, subiendo y bajando.", "Dile a tu pareja qu√© es lo que m√°s te gusta de sus gemidos.", "Besa a tu pareja desde el cuello hasta el pecho de forma lenta.", "Haz que tu pareja gima de placer sin tocarla.", "B√©sense apasionadamente con las manos de ambos atadas.", "Dale a tu pareja una 'mordida de amor' en un lugar inesperado.", "T√°pale los ojos a tu pareja y dale besos en diferentes partes del cuerpo para que adivine d√≥nde est√°.", "Desaf√≠ale a tu pareja a un juego de cartas, pero con una apuesta picante.", "Describan qu√© es lo que les atrajo de su pareja en la primera cita.", "Si tuvieran que elegir a una pareja de cine para representarlos, ¬øqui√©nes ser√≠an?", "¬øCu√°l es el recuerdo m√°s √≠ntimo que guardan de su relaci√≥n?", "¬øQu√© los hace sentir m√°s conectados con su pareja en un nivel profundo?", "Dale un masaje en la espalda a tu pareja mientras le susurras algo que te gusta de ella.", "¬øCu√°l es un logro del que te sientes orgulloso como pareja?", "Dale a tu pareja un masaje er√≥tico con los ojos vendados.", "Sus√∫rrale al o√≠do a tu pareja algo que te gustar√≠a hacer con ella en la cama.", "Describe la parte de tu cuerpo que m√°s te gusta que te besen.", "Dale un beso en el abdomen a tu pareja y sube lentamente hasta sus labios.", "B√©sale los dedos de las manos a tu pareja uno por uno, de forma lenta y sensual."
                    ],
                    4: [
                        "Haz que tu pareja se r√≠a en 30 segundos, ¬°sin hacerla cosquillas!", "Imita un animal para que tu pareja lo adivine.", "Prepara un c√≥ctel usando solo 2 ingredientes y p√≠dele a tu pareja que te d√© de beber en la boca."
                    ]
                }
            },
            en: {
                title: "Couples Game",
                developer: "Developer: PandA",
                description: "A trivia and challenge game to discover and celebrate your connection.",
                startButton: "Start Playing ‚ú®",
                levelTitle: "Choose your game mode",
                level1Title: "Level 1: Connection ü•∞",
                level1Desc: "Soft and fun questions to get to know each other better and strengthen your bond.",
                level1Button: "Let's play!",
                level2Title: "Level 2: Passion üî•",
                level2Desc: "Turn up the heat with more intimate challenges and questions.",
                level2Button: "Let's go!",
                level3Title: "Level 3: Adventure üòà",
                level3Desc: "Take things to a daring and exciting level. For the brave ones!",
                level3Button: "Dare to!",
                level0Title: "Varied Mode üé≤",
                level0Desc: "A random mix of all levels. You'll never know what's next!",
                level0Button: "Be surprised!",
                level4Title: "Questions Only Mode üó£Ô∏è",
                level4Desc: "A communication-focused mode. You'll only get questions from all levels.",
                level4Button: "Let's Talk!",
                level5Title: "Challenges Only Mode ü§∏",
                level5Desc: "For when you only want action! Physical and fun challenges from all levels.",
                level5Button: "Let's Challenge!",
                level6Title: "Progressive Mode üìà",
                level6Desc: "The game starts soft and gets more daring over time.",
                level6Button: "Go!",
                level7Title: "Custom Mode ‚úèÔ∏è",
                level7Desc: "Create your own bank of questions and challenges for a unique experience.",
                level7Button: "Create!",
                roundsTitle: "How many rounds do you want to play?",
                roundsOption: (r) => `${r} rounds`,
                startGameButton: "Start Game! üéâ",
                playerPlaceholder: "Player Name ",
                prizePlaceholder: "If I win, I want...",
                winButton: "I did it! üéâ",
                passButton: "Pass ‚û°Ô∏è",
                restartButton: "Restart",
                endTitle: "Game Over! üèÅ",
                playAgainButton: "Play Again ‚ú®",
                playerTurn: (p) => `${p}'s turn`,
                roundDisplay: (c, t) => `Round ${c} of ${t}`,
                finalScoreMessage: (p1, s1, p2, s2) => `Final Scores: ${p1}: ${s1}, ${p2}: ${s2}`,
                winMessage: (w, prize) => `${w} is the winner! Now ${w} can ask for: "${prize}".`,
                drawMessage: "It's a tie! You both must fulfill each other's wish!",
                noWinnerMessage: "Nobody won. You both must make a wish for each other!",
                timeout: "Time's up!",
                consentTitle: "Level 3 Warning!",
                consentMessage: "This level contains challenges that explore physical intimacy. Always remember the importance of mutual consent. If something doesn't feel right, say 'no' and pass. Communication is key!",
                consentButton: "Understood",
                outOfQuestions: "All questions have been used! Restart the game or choose a different mode.",
                alertTitle: "Error",
                alertNames: "Please enter both players' names.",
                alertQuestions: "Please add at least 5 questions or challenges to start custom mode.",
                settingsTitle: "Settings",
                themeLabel: "Choose a theme color:",
                closeSettingsButton: "Close",
                questions: {
                    1: [
                        "What is the funniest memory you have together?", "What romantic movie do you both like?", "If you could travel anywhere in the world right now, where would you go?", "What is your favorite food to share?", "What do you like most about their smile?", "If you had to describe their laugh in one word, what would it be?", "What is a song that reminds you of each other?", "What was your first impression of each other?", "What superpower would you choose to have together?", "If you could spend one day with no responsibilities, what would you do?", "What is the best gift you have ever given them?", "What is the best advice you've been given about love?", "What made you realize you wanted to be together?", "What's one thing you've learned from your partner?", "What's a goal you'd like to achieve together in the next five years?", "What is your partner's most adorable habit?", "What's one thing your partner does that makes you feel safe?", "What is an accomplishment you are proud of as a couple?", "If you could relive one day of your relationship, which one would you choose?", "What do you miss most about what you did when you first started dating?", "What makes you feel most emotionally connected?", "What is your favorite inside joke?", "What have you learned about love from each other?", "What is something that still surprises you about your partner?", "What is the simplest way to make you happy?", "What is something you deeply admire about your partner?"
                    ],
                    2: [
                        "Describe the most romantic moment you've shared.", "What kind of caresses do you like?", "Name a fantasy you would like to fulfill together.", "What is your favorite place to kiss?", "Give your partner a shoulder massage for one minute.", "What part of your partner's body are you most attracted to?", "Describe your ideal date for a rainy day.", "What makes you feel most loved and desired?", "Kiss them on the part of their body you like the most.", "What makes you feel most sensual and confident?", "Stroke your partner's hair while telling them something you love about their personality.", "What's your most sensual song to slow dance to?", "Describe in three words how you feel when you kiss.", "Name a non-sexual fantasy you'd like to live out together.", "What gets you most excited on a romantic date?", "Give each other a kiss that starts slow and becomes more passionate.", "What's the most romantic gesture you've ever done for your partner?", "If you had to choose a flavor for your passion, what would it be?", "Give your partner a caress on their hand that feels like a kiss.", "Kiss your partner's back while you whisper something you'd like to do to them.", "Massage your partner's feet for two minutes while you tell them what you find attractive about them.", "What is your least sexual but most sensual role-play fantasy?", "Write a sensual message on your partner's back with your finger.", "Give your partner a long, passionate kiss without using your hands.", "What is the way you most like to be touched?", "Describe a fantasy you would like to fulfill if time and place were not an issue."
                    ],
                    3: [
                        "Describe an unexpected place where you would like to have a daring date.", "What has been the craziest fantasy you've had?", "Besa el cuello de tu pareja de forma muy sensual.", "¬øQu√© juguete sexual te gustar√≠a usar en pareja?", "Describe una posici√≥n en la que quieras probar.", "Cu√©ntale una fantas√≠a er√≥tica que tengas con tu pareja y c√≥mo te gustar√≠a que fuera.", "Besa cada dedo de los pies de tu pareja.", "Besa cada parte del cuerpo de tu pareja que no le hayas besado antes.", "H√°blale a tu pareja con la voz m√°s sensual que tengas y descr√≠bele algo que te excita de ella.", "Jueguen a 'verdad o reto' pero solo con preguntas y desaf√≠os picantes.", "Dale un beso a tu pareja en el ombligo, subiendo y bajando.", "Dile a tu pareja qu√© es lo que m√°s te gusta de sus gemidos.", "Besa a tu pareja desde el cuello hasta el pecho de forma lenta.", "Haz que tu pareja gima de placer sin tocarla.", "B√©sense apasionadamente con las manos de ambos atadas.", "Dale a tu pareja una 'mordida de amor' en un lugar inesperado.", "T√°pale los ojos a tu pareja y dale besos en diferentes partes del cuerpo para que adivine d√≥nde est√°.", "Desaf√≠ale a tu pareja a un juego de cartas, pero con una apuesta picante.", "Describan qu√© es lo que les atrajo de su pareja en la primera cita.", "Si tuvieran que elegir a una pareja de cine para representarlos, ¬øqui√©nes ser√≠an?", "¬øCu√°l es el recuerdo m√°s √≠ntimo que guardan de su relaci√≥n?", "¬øQu√© los hace sentir m√°s conectados con su pareja en un nivel profundo?", "Dale un masaje en la espalda a tu pareja mientras le susurras algo que te gusta de ella.", "¬øCu√°l es un logro del que te sientes orgulloso como pareja?", "Dale a tu pareja un masaje er√≥tico con los ojos vendados.", "Sus√∫rrale al o√≠do a tu pareja algo que te gustar√≠a hacer con ella en la cama.", "Describe la parte de tu cuerpo que m√°s te gusta que te besen.", "Dale un beso en el abdomen a tu pareja y sube lentamente hasta sus labios.", "B√©sale los dedos de las manos a tu pareja uno por uno, de forma lenta y sensual."
                    ],
                    4: [
                        "Make your partner laugh in 30 seconds, without tickling them!", "Imitate an animal for your partner to guess.", "Make a cocktail using only 2 ingredients and ask your partner to drink it from your mouth."
                    ]
                }
            }
        };

        let translations = {};
        const loadingPrize1 = document.createElement('div');
        loadingPrize1.className = 'loading-spinner';
        const loadingPrize2 = document.createElement('div');
        loadingPrize2.className = 'loading-spinner';
        const loadingQuestion = document.createElement('div');
        loadingQuestion.className = 'loading-spinner';

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let audioSource = null;

        function loadTranslations() {
            const lang = languageSelect.value;
            translations = gameData[lang];
            updateText();
        }

        function updateText() {
            document.getElementById('main-title').textContent = translations.title;
            const heartSpan = document.createElement('span');
            heartSpan.id = 'heart-icon';
            heartSpan.classList.add('transition-colors', 'duration-1000');
            heartSpan.textContent = '‚ù§Ô∏è';
            document.getElementById('main-title').appendChild(heartSpan);

            document.getElementById('developer-note').textContent = translations.developer;
            document.getElementById('game-description').textContent = translations.description;
            document.getElementById('player1-name').placeholder = translations.playerPlaceholder + "1";
            document.getElementById('player2-name').placeholder = translations.playerPlaceholder + "2";
            document.getElementById('player1-prize').placeholder = translations.prizePlaceholder;
            document.getElementById('player2-prize').placeholder = translations.prizePlaceholder;
            document.getElementById('start-button').textContent = translations.startButton;
            document.getElementById('level-title').textContent = translations.levelTitle;
            document.getElementById('level1-title').textContent = translations.level1Title;
            document.getElementById('level1-desc').textContent = translations.level1Desc;
            document.getElementById('level1-button').textContent = translations.level1Button;
            document.getElementById('level2-title').textContent = translations.level2Title;
            document.getElementById('level2-desc').textContent = translations.level2Desc;
            document.getElementById('level2-button').textContent = translations.level2Button;
            document.getElementById('level3-title').textContent = translations.level3Title;
            document.getElementById('level3-desc').textContent = translations.level3Desc;
            document.getElementById('level3-button').textContent = translations.level3Button;
            document.getElementById('level0-title').textContent = translations.level0Title;
            document.getElementById('level0-desc').textContent = translations.level0Desc;
            document.getElementById('level0-button').textContent = translations.level0Button;
            document.getElementById('level4-title').textContent = translations.level4Title;
            document.getElementById('level4-desc').textContent = translations.level4Desc;
            document.getElementById('level4-button').textContent = translations.level4Button;
            document.getElementById('level5-title').textContent = translations.level5Title;
            document.getElementById('level5-desc').textContent = translations.level5Desc;
            document.getElementById('level5-button').textContent = translations.level5Button;
            document.getElementById('level6-title').textContent = translations.level6Title;
            document.getElementById('level6-desc').textContent = translations.level6Desc;
            document.getElementById('level6-button').textContent = translations.level6Button;
            document.getElementById('level7-title').textContent = translations.level7Title;
            document.getElementById('level7-desc').textContent = translations.level7Desc;
            document.getElementById('level7-button').textContent = translations.level7Button;
            document.getElementById('rounds-title').textContent = translations.roundsTitle;
            document.getElementById('option-5-rounds').textContent = translations.roundsOption(5);
            document.getElementById('option-10-rounds').textContent = translations.roundsOption(10);
            document.getElementById('option-15-rounds').textContent = translations.roundsOption(15);
            document.getElementById('option-20-rounds').textContent = translations.roundsOption(20);
            document.getElementById('option-30-rounds').textContent = translations.roundsOption(30);
            document.getElementById('start-game-button').textContent = translations.startGameButton;
            document.getElementById('win-button').textContent = translations.winButton;
            document.getElementById('pass-button').textContent = translations.passButton;
            document.getElementById('restart-button').textContent = translations.restartButton;
            document.getElementById('end-title').textContent = translations.endTitle;
            document.getElementById('play-again-button').textContent = translations.playAgainButton;
            document.getElementById('consent-title').textContent = translations.consentTitle;
            document.getElementById('consent-message').textContent = translations.consentMessage;
            document.getElementById('consent-button').textContent = translations.consentButton;
            document.getElementById('create-title').textContent = translations.level7Title;
            document.getElementById('add-question-button').textContent = translations.addQuestionButton;
            document.getElementById('play-custom-button').textContent = translations.playCustomButton;
            document.getElementById('settings-title').textContent = translations.settingsTitle;
            document.getElementById('theme-label').textContent = translations.themeLabel;
            document.getElementById('close-settings-button').textContent = translations.closeSettingsButton;
            updateScoresDisplay();
            updateTurnDisplay();
            updateRoundDisplay();
        }
        
        languageSelect.addEventListener('change', loadTranslations);
        
        const vibrate = (pattern) => {
            if (navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        };

        // Funci√≥n para cambiar de pantalla
        function showScreen(screenId) {
            startScreen.classList.add('hidden');
            levelScreen.classList.add('hidden');
            roundsScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            createGameScreen.classList.add('hidden');
            consentModal.classList.add('hidden');
            alertModal.classList.add('hidden');
            settingsModal.classList.add('hidden');
            
            document.getElementById(screenId).classList.remove('hidden');
            
            if (screenId !== 'start-screen' && screenId !== 'end-screen') {
                backButtonContainer.classList.remove('hidden');
            } else {
                backButtonContainer.classList.add('hidden');
            }
        }
        
        window.loadGame = async () => {
            const savedGame = await window.loadGameState();
            if (savedGame) {
                player1Name = savedGame.player1Name;
                player2Name = savedGame.player2Name;
                player1Prize = savedGame.player1Prize;
                player2Prize = savedGame.player2Prize;
                player1Score = savedGame.player1Score;
                player2Score = savedGame.player2Score;
                currentPlayer = savedGame.currentPlayer;
                currentRound = savedGame.currentRound;
                totalRounds = savedGame.totalRounds;
                currentLevel = savedGame.currentLevel;
                usedQuestions = savedGame.usedQuestions;

                player1NameInput.value = player1Name;
                player2NameInput.value = player2Name;
                if (player1PrizeInput) player1PrizeInput.value = player1Prize;
                if (player2PrizeInput) player2PrizeInput.value = player2Prize;
                
                if (player1Name) player1PrizeContainer.classList.add('active');
                if (player2Name) player2PrizeContainer.classList.add('active');

                if (currentRound <= totalRounds) {
                    showScreen('game-screen');
                    displayQuestion();
                } else {
                    showScreen('end-screen');
                    displayEndScreen();
                }
            } else {
                showScreen('start-screen');
            }
        };

        window.togglePrizeInput = (playerNum) => {
            const nameInput = document.getElementById(`player${playerNum}-name`);
            const prizeContainer = document.getElementById(`player${playerNum}-prize-container`);
            if (nameInput.value.trim() !== '') {
                prizeContainer.classList.add('active');
            } else {
                prizeContainer.classList.remove('active');
                if (document.getElementById(`player${playerNum}-prize`)) {
                    document.getElementById(`player${playerNum}-prize`).value = '';
                }
            }
        };

        function saveGame() {
            const gameState = {
                player1Name,
                player2Name,
                player1Prize,
                player2Prize,
                player1Score,
                player2Score,
                currentPlayer,
                currentRound,
                totalRounds,
                currentLevel,
                usedQuestions
            };
            window.saveGameState(gameState);
        }

        function showAlertModal(title, message) {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            alertModal.classList.remove('hidden');
        }

        window.closeAlertModal = function() {
            alertModal.classList.add('hidden');
        };

        window.toggleSettingsModal = function() {
            settingsModal.classList.toggle('hidden');
        };

        window.closeSettingsModal = function() {
            settingsModal.classList.add('hidden');
        };

        window.setAccentColor = function(color, rgb, button) {
            document.body.style.setProperty('--accent-color', color);
            document.body.style.setProperty('--accent-color-rgb', rgb);
            const buttons = document.querySelectorAll('.color-picker-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            if (button) button.classList.add('active');
        };

        window.startGame = function() {
            player1Name = player1NameInput.value.trim();
            player2Name = player2NameInput.value.trim();
            player1Prize = player1PrizeInput.value.trim() || translations.prizePlaceholder;
            player2Prize = player2PrizeInput.value.trim() || translations.prizePlaceholder;
            
            if (player1Name && player2Name) {
                clickSound.play();
                showScreen('level-screen');
                saveGame();
            } else {
                showAlertModal(translations.alertTitle, translations.alertNames);
            }
        };
        
        window.selectLevel = async function(level) {
            currentLevel = level;
            clickSound.play();

            if (currentLevel === 7) {
                customQuestions = await window.getCustomQuestions();
                showScreen('create-game-screen');
            } else if (currentLevel === 3 || currentLevel === 0 || currentLevel === 6) {
                showConsentModal();
            } else {
                showScreen('rounds-screen');
            }
            saveGame();
        };

        function showConsentModal() {
            consentModal.classList.remove('hidden');
        }

        window.closeConsentModal = function() {
            clickSound.play();
            consentModal.classList.add('hidden');
            showScreen('rounds-screen');
        };

        window.addCustomQuestion = async function() {
            const question = document.getElementById('custom-question-input').value.trim();
            if (question) {
                await window.saveCustomQuestion(question);
                customQuestions.push(question);
                document.getElementById('custom-question-input').value = '';
                showAlertModal('√âxito', '¬°Pregunta o reto agregado!');
            }
        };
        
        window.startCustomGame = function() {
            if (customQuestions.length < 5) {
                showAlertModal(translations.alertTitle, translations.alertQuestions);
            } else {
                showScreen('rounds-screen');
            }
        };

        window.selectRounds = function() {
            clickSound.play();
            totalRounds = parseInt(totalRoundsSelect.value);
            currentRound = 1;
            player1Score = 0;
            player2Score = 0;
            currentPlayer = 1;
            usedQuestions = {};
            showScreen('game-screen');
            displayQuestion();
            saveGame();
        };

        window.goBack = function() {
            clickSound.play();
            clearInterval(timerInterval);
            if (!levelScreen.classList.contains('hidden')) {
                showScreen('start-screen');
            } else if (!roundsScreen.classList.contains('hidden')) {
                if (currentLevel === 7) {
                    showScreen('create-game-screen');
                } else {
                    showScreen('level-screen');
                }
            } else if (!gameScreen.classList.contains('hidden')) {
                showScreen('rounds-screen');
            } else if (!createGameScreen.classList.contains('hidden')) {
                showScreen('level-screen');
            }
        };

        function displayQuestion() {
            if (currentRound > totalRounds) {
                showScreen('end-screen');
                displayEndScreen();
                return;
            }

            let questionList;
            let currentLang = languageSelect.value;

            if (currentLevel === 0) { // Modo Variado
                allQuestions = [...gameData[currentLang].questions[1], ...gameData[currentLang].questions[2], ...gameData[currentLang].questions[3]];
                const availableQuestions = allQuestions.filter((q) => !usedQuestions[q]);
                questionList = availableQuestions.length === 0 ? allQuestions : availableQuestions;
            } else if (currentLevel === 4) { // Solo Preguntas
                allQuestions = [...gameData[currentLang].questions[1], ...gameData[currentLang].questions[2], ...gameData[currentLang].questions[3]].filter(q => q.includes('?'));
                const availableQuestions = allQuestions.filter((q) => !usedQuestions[q]);
                questionList = availableQuestions.length === 0 ? allQuestions : availableQuestions;
            } else if (currentLevel === 5) { // Solo Retos
                allQuestions = [...gameData[currentLang].questions[1], ...gameData[currentLang].questions[2], ...gameData[currentLang].questions[3]].filter(q => !q.includes('?'));
                const availableQuestions = allQuestions.filter((q) => !usedQuestions[q]);
                questionList = availableQuestions.length === 0 ? allQuestions : availableQuestions;
            } else if (currentLevel === 6) { // Modo Progresivo
                let currentProgressionLevel = 1;
                if (currentRound > totalRounds / 3 * 2) {
                    currentProgressionLevel = 3;
                } else if (currentRound > totalRounds / 3) {
                    currentProgressionLevel = 2;
                }
                allQuestions = gameData[currentLang].questions[currentProgressionLevel];
                const availableQuestions = allQuestions.filter((q) => !usedQuestions[q]);
                questionList = availableQuestions.length === 0 ? allQuestions : availableQuestions;
            } else if (currentLevel === 7) { // Modo Personalizado
                questionList = customQuestions;
            } else {
                allQuestions = gameData[currentLang].questions[currentLevel];
                const availableQuestions = allQuestions.filter((q) => !usedQuestions[q]);
                questionList = availableQuestions.length === 0 ? allQuestions : availableQuestions;
            }

            if (questionList.length === 0) {
                questionText.textContent = translations.outOfQuestions;
                document.getElementById('action-buttons').classList.add('hidden');
                return;
            }
            document.getElementById('action-buttons').classList.remove('hidden');
            
            const randomIndex = Math.floor(Math.random() * questionList.length);
            const question = questionList[randomIndex];
            questionText.textContent = question;
            
            usedQuestions[question] = true;
            
            updateScoresDisplay();
            updateTurnDisplay();
            updateRoundDisplay();
            startTimer();
            saveGame();
        }

        async function generatePrizeIdea(playerNum) {
            const player1Name = document.getElementById('player1-name').value;
            const player2Name = document.getElementById('player2-name').value;
            const prizeInput = document.getElementById(`player${playerNum}-prize`);
            
            prizeInput.value = 'Generando idea...';
            const button = prizeInput.parentNode.querySelector('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="loading-spinner"></div>';
            button.disabled = true;

            const prompt = `Act√∫a como un planificador de citas rom√°nticas. Genera una idea de premio muy creativa y rom√°ntica para una pareja que acaba de jugar un juego de retos. Los nombres son ${player1Name} y ${player2Name}. La idea debe ser concisa y en una sola frase.`;
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "Debes generar una idea de premio √∫nica y personalizada para una pareja. El premio debe ser algo que puedan hacer juntos, como una experiencia o una actividad. No seas gen√©rico. La respuesta debe ser una sola frase." }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    prizeInput.value = text.trim().replace(/^"|"$/g, '');
                } else {
                    prizeInput.value = 'No se pudo generar una idea, ¬°intenta de nuevo!';
                }
            } catch (error) {
                console.error("Error al llamar a la API de Gemini:", error);
                prizeInput.value = 'Error al generar la idea.';
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function generateQuestionWithGemini() {
            const button = document.getElementById('gemini-question-button');
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="loading-spinner"></div>';
            button.disabled = true;

            const currentLang = languageSelect.value;
            const player1Name = document.getElementById('player1-name').value;
            const player2Name = document.getElementById('player2-name').value;
            
            let levelDescription = '';
            if (currentLevel === 1) levelDescription = gameData[currentLang].level1Desc;
            if (currentLevel === 2) levelDescription = gameData[currentLang].level2Desc;
            if (currentLevel === 3) levelDescription = gameData[currentLang].level3Desc;

            const prompt = `Genera una pregunta o reto √∫nico e interesante para una pareja llamada ${player1Name} y ${player2Name}. El tono debe ser: ${levelDescription}. La respuesta debe ser en ${currentLang}. No seas expl√≠cito.`;
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "Genera una pregunta o reto que se ajuste al tono y nivel de intimidad de un juego para parejas. La respuesta debe ser una sola frase." }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    questionText.textContent = text.trim().replace(/^"|"$/g, '');
                    usedQuestions[text] = true;
                } else {
                    questionText.textContent = 'No se pudo generar una pregunta. ¬°Intenta de nuevo!';
                }
            } catch (error) {
                console.error("Error al llamar a la API de Gemini:", error);
                questionText.textContent = 'Error al generar la pregunta.';
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        window.readQuestion = async function() {
            const textToRead = questionText.textContent;
            if (!textToRead || textToRead.startsWith('¬°') || textToRead.startsWith('No se pudo')) {
                return;
            }

            const button = document.getElementById('read-button');
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="loading-spinner"></div>';
            button.disabled = true;

            const lang = languageSelect.value;
            const voiceMap = {
                es: "Kore",
                en: "Puck"
            };
            const selectedVoice = voiceMap[lang] || "Kore";

            const payload = {
                contents: [{ parts: [{ text: textToRead }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: selectedVoice }
                        }
                    }
                }
            };
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;

                if (audioData) {
                    const audioBuffer = base64ToArrayBuffer(audioData);
                    playPCM(audioBuffer, 24000); // 24000 es la tasa de muestreo para esta API
                } else {
                    console.error('No se pudo obtener datos de audio.');
                }

            } catch (error) {
                console.error('Error al generar o reproducir el audio:', error);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        };

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function playPCM(pcmData, sampleRate) {
            if (audioSource) {
                audioSource.stop();
                audioSource = null;
            }

            const buffer = audioContext.createBuffer(1, pcmData.byteLength / 2, sampleRate);
            const channelData = buffer.getChannelData(0);
            const pcm16 = new Int16Array(pcmData);
            for (let i = 0; i < pcm16.length; i++) {
                channelData[i] = pcm16[i] / 32768;
            }

            audioSource = audioContext.createBufferSource();
            audioSource.buffer = buffer;
            audioSource.connect(audioContext.destination);
            audioSource.start();
        }

        function nextQuestion() {
            clickSound.play();
            clearInterval(timerInterval);
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            if (currentPlayer === 1) {
                currentRound++;
            }
            displayQuestion();
        }

        window.passWithConsequence = function() {
            clickSound.play();
            if (currentPlayer === 1) {
                player1Score = Math.max(0, player1Score - 1);
            } else {
                player2Score = Math.max(0, player2Score - 1);
            }
            nextQuestion();
        };

        window.addPointAndNext = function() {
            clickSound.play();
            let points = 1;
            if (currentLevel === 2) points = 2;
            if (currentLevel === 3) points = 3;
            if (currentLevel === 6) {
                if (currentRound > totalRounds / 3 * 2) points = 3;
                else if (currentRound > totalRounds / 3) points = 2;
                else points = 1;
            }

            if (currentPlayer === 1) {
                player1Score += points;
            } else {
                player2Score += points;
            }
            nextQuestion();
        };

        function updateScoresDisplay() {
            player1ScoreDisplay.textContent = `${player1Name}: ${player1Score}`;
            player2ScoreDisplay.textContent = `${player2Name}: ${player2Score}`;
            
            const progress = (currentRound - 1) / totalRounds * 100;
            progressBar.style.width = `${progress}%`;
        }

        function updateTurnDisplay() {
            const player = currentPlayer === 1 ? player1Name : player2Name;
            playerTurnDisplay.textContent = translations.playerTurn(player);
        }

        function updateRoundDisplay() {
            roundDisplay.textContent = translations.roundDisplay(currentRound, totalRounds);
        }

        function displayEndScreen() {
            let message;
            let winnerPrize = '';
            let loserPrize = '';

            if (player1Score > player2Score) {
                winnerPrize = player1Prize;
                message = translations.winMessage(player1Name, winnerPrize);
            } else if (player2Score > player1Score) {
                winnerPrize = player2Prize;
                message = translations.winMessage(player2Name, winnerPrize);
            } else if (player1Score === 0 && player2Score === 0) {
                 message = translations.noWinnerMessage;
            } else {
                message = translations.drawMessage;
            }

            winnerMessage.textContent = message;
            finalScores.textContent = translations.finalScoreMessage(player1Name, player1Score, player2Name, player2Score);
            endMessage.textContent = "El perdedor debe cumplir un deseo del ganador. ¬°Elijan con cuidado!";
            saveGame();
        }
        
        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 30;
            timerDisplay.textContent = timeLeft;
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 5) {
                    vibrate([200, 100, 200]);
                    timerDisplay.classList.add('text-red-500', 'dark:text-red-400');
                } else {
                    timerDisplay.classList.remove('text-red-500', 'dark:text-red-400');
                }
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    questionText.textContent = translations.timeout;
                    vibrate([500, 50, 500]);
                    setTimeout(() => {
                        nextQuestion();
                    }, 2000);
                }
            }, 1000);
        }
        
        window.restartGame = function() {
            clickSound.play();
            clearInterval(timerInterval);
            showScreen('start-screen');
            loadTranslations();
        };

        window.toggleDarkMode = function() {
            const html = document.documentElement;
            const isDarkMode = html.classList.toggle('dark');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const sunIconSettings = document.getElementById('sun-icon-settings');
            const moonIconSettings = document.getElementById('moon-icon-settings');

            if (isDarkMode) {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                if (sunIconSettings) sunIconSettings.classList.add('hidden');
                if (moonIconSettings) moonIconSettings.classList.remove('hidden');
            } else {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                if (sunIconSettings) sunIconSettings.classList.remove('hidden');
                if (moonIconSettings) moonIconSettings.classList.add('hidden');
            }
        };
        
        loadTranslations();
    </script>
</body>
</html>
A